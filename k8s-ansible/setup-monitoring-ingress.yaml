- name: Setup Monitoring Ingress and Dashboards
  hosts: masters
  become: yes
  vars:
    master_kubeconfig: /home/ubuntu/.kube/config

  tasks:
    - name: Copy Grafana dashboards configmap to master
      copy:
        src: "{{ playbook_dir }}/../k8s_helm/grafana-dashboards-configmap.yaml"
        dest: /tmp/grafana-dashboards-configmap.yaml

    - name: Copy Grafana ingress to master
      copy:
        src: "{{ playbook_dir }}/../k8s_helm/grafana-ingress.yaml"
        dest: /tmp/grafana-ingress.yaml

    - name: Copy Prometheus ingress to master
      copy:
        src: "{{ playbook_dir }}/../k8s_helm/prometheus-ingress.yaml"
        dest: /tmp/prometheus-ingress.yaml

    - name: Apply Grafana dashboards configmap
      shell: kubectl apply -f /tmp/grafana-dashboards-configmap.yaml
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      ignore_errors: yes

    - name: Get actual Grafana service name
      shell: kubectl get svc -n monitoring -l app.kubernetes.io/name=grafana -o jsonpath='{.items[0].metadata.name}'
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      register: grafana_service_name
      ignore_errors: yes
      changed_when: false

    - name: Update Grafana ingress with correct service name
      replace:
        path: /tmp/grafana-ingress.yaml
        regexp: 'name: prometheus-grafana'
        replace: 'name: {{ grafana_service_name.stdout | default("prometheus-grafana") }}'
      when: grafana_service_name.stdout is defined

    - name: Apply Grafana ingress
      shell: kubectl apply -f /tmp/grafana-ingress.yaml
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      ignore_errors: yes

    - name: Get actual Prometheus service name (try multiple methods)
      shell: |
        # Try different label selectors
        kubectl get svc -n monitoring -l app=kube-prometheus-stack-prometheus -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || \
        kubectl get svc -n monitoring -l app.kubernetes.io/name=prometheus -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || \
        kubectl get svc -n monitoring -l "app.kubernetes.io/instance=prometheus" -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || \
        kubectl get svc -n monitoring | grep -E "prometheus.*9090|prometheus.*80" | head -1 | awk '{print $1}' 2>/dev/null || \
        echo "prometheus-kube-prometheus-prometheus"
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      register: prometheus_service_name
      ignore_errors: yes
      changed_when: false

    - name: Display found Prometheus service name
      debug:
        msg: "Found Prometheus service: {{ prometheus_service_name.stdout }}"

    - name: Update Prometheus ingress with correct service name
      replace:
        path: /tmp/prometheus-ingress.yaml
        regexp: 'name: prometheus-kube-prometheus-prometheus'
        replace: 'name: {{ prometheus_service_name.stdout | default("prometheus-kube-prometheus-prometheus") }}'
      when: prometheus_service_name.stdout is defined and prometheus_service_name.stdout | length > 0 and prometheus_service_name.stdout != "prometheus-kube-prometheus-prometheus"

    - name: Apply Prometheus ingress
      shell: kubectl apply -f /tmp/prometheus-ingress.yaml
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      ignore_errors: yes
      register: prometheus_ingress_result

    - name: Display Prometheus ingress result
      debug:
        msg: "Prometheus ingress apply result: {{ prometheus_ingress_result.stdout_lines | default(['No output']) }}"
      when: prometheus_ingress_result.stderr is defined

    - name: Display ingress status
      debug:
        msg: |
          Monitoring ingress configured!
          Grafana: http://grafana.local
          Prometheus: http://prometheus.local

