- name: Fix Storage and Redeploy Postgres
  hosts: masters
  become: yes
  vars:
    master_kubeconfig: /home/ubuntu/.kube/config

  tasks:
    - name: Add EBS CSI Driver Helm repo
      command: helm repo add aws-ebs-csi-driver https://kubernetes-sigs.github.io/aws-ebs-csi-driver
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      ignore_errors: yes

    - name: Update Helm repos
      command: helm repo update
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"

    - name: Install EBS CSI Driver
      command: >
        helm upgrade --install aws-ebs-csi-driver aws-ebs-csi-driver/aws-ebs-csi-driver
        --namespace kube-system
        --set controller.serviceAccount.create=true
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      ignore_errors: yes

    - name: Create default GP3 storage class
      shell: |
        kubectl apply -f - <<'EOF'
        apiVersion: storage.k8s.io/v1
        kind: StorageClass
        metadata:
          name: gp3
          annotations:
            storageclass.kubernetes.io/is-default-class: "true"
        provisioner: ebs.csi.aws.com
        volumeBindingMode: WaitForFirstConsumer
        parameters:
          type: gp3
          fsType: ext4
        EOF
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"

    - name: Delete existing postgres resources
      shell: |
        kubectl delete statefulset postgres -n meo-stationery --ignore-not-found=true
        kubectl delete pvc postgres-storage-postgres-0 -n meo-stationery --ignore-not-found=true
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      ignore_errors: yes

    - name: Wait for cleanup
      pause:
        seconds: 10

    - name: Copy updated database values.yaml
      copy:
        src: ../k8s_helm/database/values.yaml
        dest: /home/ubuntu/k8s_helm/database/values.yaml

    - name: Copy updated statefulset template
      copy:
        src: ../k8s_helm/database/templates/statefulset.yaml
        dest: /home/ubuntu/k8s_helm/database/templates/statefulset.yaml

    - name: Redeploy postgres
      command: >
        helm upgrade postgres database
        --namespace meo-stationery
        --values database/values.yaml
        --install
      args:
        chdir: /home/ubuntu/k8s_helm
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"

    - name: Check postgres status
      command: kubectl get pods -n meo-stationery -l app.kubernetes.io/name=postgres
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      register: postgres_pods

    - name: Show postgres status
      debug:
        var: postgres_pods.stdout_lines

