- name: Debug Ingress Routing Issue
  hosts: masters
  become: yes
  vars:
    master_kubeconfig: /home/ubuntu/.kube/config

  tasks:
    - name: Check ingress configuration
      shell: kubectl get ingress backend -n meo-stationery -o yaml
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      register: ingress_yaml

    - name: Show ingress YAML
      debug:
        var: ingress_yaml.stdout_lines

    - name: Check backend service
      shell: kubectl get svc backend -n meo-stationery -o yaml
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      register: backend_svc

    - name: Show backend service
      debug:
        var: backend_svc.stdout_lines

    - name: Test backend service directly
      shell: kubectl run test-curl --image=curlimages/curl:latest --rm -i --restart=Never -n meo-stationery -- curl -v http://backend.meo-stationery.svc.cluster.local
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      register: backend_test
      ignore_errors: yes

    - name: Show backend test result
      debug:
        var: backend_test.stdout_lines

    - name: Test ingress from inside cluster
      shell: kubectl run test-ingress --image=curlimages/curl:latest --rm -i --restart=Never -n meo-stationery -- curl -H "Host: meo-stationery.local" -v http://ingress-nginx-controller.ingress-nginx.svc.cluster.local
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      register: ingress_test
      ignore_errors: yes

    - name: Show ingress test result
      debug:
        var: ingress_test.stdout_lines

    - name: Check ingress controller logs
      shell: kubectl logs -n ingress-nginx -l app.kubernetes.io/component=controller --tail=20
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      register: ingress_logs
      ignore_errors: yes

    - name: Show ingress logs
      debug:
        var: ingress_logs.stdout_lines

    - name: Get NodePort
      shell: kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.spec.ports[?(@.name=="http")].nodePort}'
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      register: nodeport

    - name: Test NodePort directly
      shell: curl -H "Host: meo-stationery.local" http://localhost:{{ nodeport.stdout }} -v
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      register: nodeport_test
      ignore_errors: yes

    - name: Show NodePort test result
      debug:
        var: nodeport_test.stdout_lines

