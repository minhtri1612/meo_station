- name: Check and Setup NGINX Ingress Access
  hosts: masters
  become: yes
  vars:
    master_kubeconfig: /home/ubuntu/.kube/config

  tasks:
    - name: Check if backend ingress is deployed
      shell: kubectl get ingress backend -n meo-stationery
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      register: ingress_exists
      ignore_errors: yes

    - name: Deploy ingress if not exists
      shell: |
        cd /home/ubuntu/k8s_helm
        helm upgrade backend backend \
          --namespace meo-stationery \
          --values backend/values.yaml \
          --reuse-values
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      when: ingress_exists.rc != 0

    - name: Get ingress controller service details
      shell: kubectl get svc -n ingress-nginx ingress-nginx-controller -o yaml
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      register: ingress_svc

    - name: Get NodePort for HTTP
      shell: kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.spec.ports[?(@.name=="http")].nodePort}'
      environment:
        KUBECONFIG: "{{ master_kubeconfig }}"
      register: nodeport
      ignore_errors: yes

    - name: Get master public IP
      shell: curl -s ifconfig.me || curl -s https://api.ipify.org
      register: master_ip
      ignore_errors: yes

    - name: Show access instructions
      debug:
        msg: |
          ============================================
          ACCESS YOUR APPLICATION VIA NGINX INGRESS:
          ============================================
          
          Step 1: Add to your local /etc/hosts:
            sudo echo "{{ master_ip.stdout }} meo-stationery.local" >> /etc/hosts
          
          Step 2: Access your application:
            http://meo-stationery.local:{{ nodeport.stdout }}
          
          Master Node IP: {{ master_ip.stdout }}
          Ingress NodePort: {{ nodeport.stdout }}
          
          ============================================

